(function(){var e,i,k,h,j,l,f,o,q,r,c,b,g,n,a,m,p;var d=function(s,t){return function(){return s.apply(t,arguments)}};i=Backbone.Model.extend({assetSelectionCallback:function(s){this.closeMediaChooserModal();return this.trigger("assetSelected",s)},selectedTemplate:function(s){if(s){this.set("selectedTemplate",s)}return this.get("selectedTemplate")},rootTemplateGroup:function(s){if(s){this.set("rootTemplateGroup",s)}return this.get("rootTemplateGroup")},openNewTemplateModal:function(s){return this.trigger("openNewTemplateModal",s)},openNewTemplateGroupModal:function(){return this.trigger("openNewTemplateGroupModal")},openEditTemplateGroupModal:function(s){return this.trigger("openEditTemplateGroupModal",s)},openConfirmDeleteTemplateModal:function(){return this.trigger("openConfirmDeleteTemplateModal")},openConfirmDeleteTemplateGroupModal:function(s){return this.trigger("openConfirmDeleteTemplateGroupModal",s)},openMediaChooserModal:function(){return this.trigger("openMediaChooserModal")},closeMediaChooserModal:function(){return this.trigger("closeMediaChooserModal")}});n=Backbone.Model.extend({urlRoot:templateGroupRoot,indexTemplateModel:function(s){if(s){this._indexTemplateModel=s}return this._indexTemplateModel}});p=Backbone.Model.extend({urlRoot:templateRoot,initialFetch:function(){return this.fetch({success:d(function(){return this.trigger("initialFetchComplete")},this)})},templateGroupModel:function(s){if(s){this._templateGroupModel=s}return this._templateGroupModel},errors:function(s){if(s){this._errors=s;this.trigger("errors",this._errors)}return this._errors},requiresSave:function(s){if(s||s===false){this._requiresSave=s;this.trigger("change")}return this._requiresSave},getMode:function(){switch(this.get("template_content_type")){case"text/html":case"text/xhtml+xml":return"ace/mode/html";case"text/css":return"ace/mode/css";case"application/javascript":return"ace/mode/javascript";case"application/json":return"ace/mode/json";case"application/rss+xml":case"application/atom+xml":case"text/xml":case"application/soap+xml":return"ace/mode/xml";case"text/less":return"ace/mode/less";case"text/scss":return"ace/mode/scss";default:return"ace/mode/text"}}});c=Backbone.Collection.extend({model:p,url:templateRoot});g=Backbone.Collection.extend({model:n});e=Backbone.View.extend({initialize:function(){return this.model.on("change:selectedTemplate",this.selectedTemplateChangeHandler,this)},events:{"click #create-templategroup-button":"createTemplateGroupClickHandler","click #delete-template-button":"deleteTemplateClickHandler","click #save-template-button":"saveTemplateClickHandler"},selectedTemplateChangeHandler:function(){var s;s=this.model.get("selectedTemplate");if(s.get("template_short_name")==="index"){return $("#delete-template-button").addClass("disabled")}else{return $("#delete-template-button").removeClass("disabled")}},createTemplateGroupClickHandler:function(s){this.model.openNewTemplateGroupModal();return s.preventDefault()},deleteTemplateClickHandler:function(s){if(!$("#delete-template-button").hasClass("disabled")){this.model.openConfirmDeleteTemplateModal()}return s.preventDefault()},saveTemplateClickHandler:function(t){var s;if($("#save-template-button").hasClass("disabled")){return}$("#save-template-button").addClass("disabled");s=this.model.selectedTemplate();s.errors({});s.save({},{wait:true,success:function(v,u){v.requiresSave(false);return $("#save-template-button").removeClass("disabled")},error:function(v,u){var w;w=$.parseJSON(u.responseText);s.errors(w.errors);return $("#save-template-button").removeClass("disabled")}});return t.preventDefault()}});r=Backbone.View.extend({initialize:function(){this.$el.find("> ul > li").each(d(function(t,v){var w,s,u;s=new n({id:parseInt($(v).attr("data-id")),templategroup_short_name:$(v).find(".group-header h3").text()});u=new a({el:v,model:s,collection:this.options.templateCollection,appModel:this.model});if(s.get("templategroup_short_name")==="root"){w=u.getIndexModel();this.model.selectedTemplate(w);this.model.rootTemplateGroup(s)}return this.options.templateGroupCollection.add(s,{silent:true})},this));return this.options.templateGroupCollection.on("add",this.templateGroupAddHandler,this)},sort:function(){this.$el.find("> ul > li").tsort(".group-header h3");return this.$el.find("> ul").prepend(this.$el.find("ul > li .group-header h3:contains(root)").closest("li"))},templateGroupAddHandler:function(s){var u,t;t=$(_.template($("#templategroup-list-item-template").text(),s.toJSON()));this.$el.find("> ul").prepend(t);u=new a({el:t,model:s,collection:this.options.templateCollection,appModel:this.model});return this.sort()}});a=Backbone.View.extend({initialize:function(){this.$el.find("ul.collapse > li").each(d(function(u,v){var s,t;s=new p({id:$(v).attr("data-id"),templategroup:this.model.id,template_short_name:$.trim($(v).text())});s.templateGroupModel(this.model);t=new m({el:v,model:s,appModel:this.options.appModel});this.collection.add(s,{silent:true});if(s.get("template_short_name")==="index"){return this.model.indexTemplateModel(s)}},this));this.collection.on("add",this.templateAddedHandler,this);this.model.on("destroy",this.destroyHandler,this);return this.model.on("change",this.render,this)},events:{"click .new-template-button":"newTemplateButtonClickHandler","click .edit-templategroup-button":"editTemplateGroupButtonClickHandler"},newTemplateButtonClickHandler:function(s){this.options.appModel.openNewTemplateModal(this.model);s.stopPropagation();return s.preventDefault()},editTemplateGroupButtonClickHandler:function(s){this.options.appModel.openEditTemplateGroupModal(this.model);s.preventDefault();return s.stopPropagation()},sort:function(){this.$el.find("> ul > li").tsort();return this.$el.find("> ul").prepend(this.$el.find("[data-is-index=1]"))},templateAddedHandler:function(t){var s,u;if(t.get("templategroup")===this.model.id){s=$(_.template($("#template-list-item-template").text(),t.toJSON()));this.$el.find("ul.collapse").prepend(s);this.sort();u=new m({el:s,model:t,appModel:this.options.appModel});u.modelPopulated=true;return this.options.appModel.selectedTemplate(t)}},getIndexModel:function(){var s;s=this.collection.where({templategroup:this.model.id});return _.find(s,function(t){return t.get("template_short_name")==="index"})},destroyHandler:function(){return this.$el.remove()},render:function(){return this.$el.find(".group-header h3").text(this.model.get("templategroup_short_name"))}});m=Backbone.View.extend({initialize:function(){this.options.appModel.on("change:selectedTemplate",this.selectedTemplateChangeHandler,this);this.model.on("destroy",this.modelDestroyHandler,this);return this.model.on("change",this.render,this)},events:{"click a":"clickHandler"},clickHandler:function(s){this.options.appModel.selectedTemplate(this.model);return s.preventDefault()},selectedTemplateChangeHandler:function(){var s;s=this.options.appModel.get("selectedTemplate");if(s===this.model){if(!this.model.has("template_content")){this.model.initialFetch()}return this.$el.addClass("active")}else{return this.$el.removeClass("active")}},modelDestroyHandler:function(){return this.$el.remove()},render:function(){if(this.model.templateGroupModel().indexTemplateModel()===this.model){this.$el.find("a em").text(this.model.get("template_short_name"))}else{this.$el.find("a").text(this.model.get("template_short_name"))}if(this.model.requiresSave()){return this.$el.addClass("unsaved")}else{return this.$el.removeClass("unsaved")}}});b=Backbone.View.extend({initialize:function(){this.editor=ace.edit("editor");this.editor.setTheme("ace/theme/twilight");this.editor.setShowPrintMargin(false);this.editor.getSession().on("change",_.bind(this.editorChangeHandler,this));this.setMode("ace/mode/html");this.model.on("change:selectedTemplate",this.selectedTemplateChangeHandler,this);this.selectedTemplateChangeHandler();$("#tabs").on("shown",_.bind(this.tabShownHandler,this));this.ignoreEditorChange=false;return this.model.on("assetSelected",this.assetSelectedHandler,this)},events:{"click #media_chooser_button":"mediaChooserButtonClickHandler"},assetSelectedHandler:function(s){log("ASSET SELECTED",s);return this.editor.insert(s.url)},mediaChooserButtonClickHandler:function(s){this.model.openMediaChooserModal();return s.preventDefault()},tabShownHandler:function(s){if(this.$el.hasClass("active")&&this.templateModel){this.setValue(this.templateModel.get("template_content"));if(this.getMode()!==this.templateModel.getMode()){return this.setMode(this.templateModel.getMode())}}},editorChangeHandler:function(s){if(this.ignoreEditorChange){return}this.templateModel=this.model.get("selectedTemplate");this.templateModel.requiresSave(true);return this.templateModel.set("template_content",this.editor.getSession().getValue())},selectedTemplateChangeHandler:function(){if(this.templateModel){this.templateModel.off("initialFetchComplete",this.initialFetchCompleteHandler,this);this.templateModel.off("change:template_content_type",this.contentTypeChangeHandler,this)}this.templateModel=this.model.get("selectedTemplate");this.templateModel.on("initialFetchComplete",this.initialFetchCompleteHandler,this);this.templateModel.on("change:template_content_type",this.contentTypeChangeHandler,this);this.setValue(this.templateModel.get("template_content"));return this.setMode(this.templateModel.getMode())},contentTypeChangeHandler:function(){return this.setMode(this.templateModel.getMode())},setValue:function(s){this.ignoreEditorChange=true;this.editor.getSession().clearAnnotations();this.editor.getSession().setValue(s);return this.ignoreEditorChange=false},initialFetchCompleteHandler:function(){this.setValue(this.templateModel.get("template_content"));return this.setMode(this.templateModel.getMode())},setMode:function(s){return this.editor.getSession().setMode(s)},getMode:function(){return this.editor.getSession().getMode().$id}});q=Backbone.View.extend({initialize:function(){this.model.on("change:selectedTemplate",this.selectedTemplateChangeHandler,this);return this.selectedTemplateChangeHandler()},events:{"change :input":"inputChangeHander"},inputChangeHander:function(){var s;s=this.$el.find("form").serializeObject();if(this.templateModel){this.templateModel.set(s,{silent:true});return this.templateModel.requiresSave(true)}},selectedTemplateChangeHandler:function(){var s;if(this.templateModel){this.templateModel.off("change",this.populateFromModel,this);this.templateModel.off("errors",this.renderErrors,this)}this.templateModel=this.model.get("selectedTemplate");if(this.templateModel){this.templateModel.on("change",this.populateFromModel,this);this.templateModel.on("errors",this.renderErrors,this);this.populateFromModel()}this.removeErrors();s=this.templateModel.errors();if(s){return this.renderErrors(s)}},removeErrors:function(){this.$el.find(".alert").remove();return this.$el.find(".error").removeClass("error")},renderErrors:function(t){var s;this.removeErrors();s="";return _.each(t,function(v,u){_.each(v,function(x,w){return s+=_.template("<li><%= error %></li>",{error:x})});$("#id_"+u).before(_.template($("#form-error-template").text(),{errors:s}));return $("#id_"+u).parent().addClass("error")})},populateFromModel:function(){if(this.templateModel.get("template_short_name")){$("#id_template_short_name").val(this.templateModel.get("template_short_name"));$("#id_template_content_type").val(this.templateModel.get("template_content_type"));$("#id_template_cache_timeout").val(this.templateModel.get("template_cache_timeout"));$("#id_template_redirect_type").val(this.templateModel.get("template_redirect_type"));$("#id_template_redirect_url").val(this.templateModel.get("template_redirect_url"));$("#id_templategroup").val(this.templateModel.get("templategroup"));$("input:radio[name=template_is_private][value='True']").attr("checked",this.templateModel.get("template_is_private"));$("input:radio[name=template_is_private][value='False']").attr("checked",!this.templateModel.get("template_is_private"));if(this.templateModel.get("template_short_name")==="index"){return $("#id_template_short_name").parent().parent().hide()}else{return $("#id_template_short_name").parent().parent().show()}}}});l=Backbone.View.extend({initialize:function(){this.model.on("openMediaChooserModal",this.open,this);return this.model.on("closeMediaChooserModal",this.close,this)},open:function(){return this.$el.modal("show")},close:function(){return this.$el.modal("hide")}});h=Backbone.View.extend({initialize:function(){return this.model.on("openConfirmDeleteTemplateModal",this.open,this)},events:{"click #confirm-delete-template-button":"confirmDeleteHandler"},open:function(){return this.$el.modal("show")},close:function(){return this.$el.modal("hide")},confirmDeleteHandler:function(t){var s;s=this.model.get("selectedTemplate");s.destroy();this.close();this.model.selectedTemplate(s.templateGroupModel().indexTemplateModel());return t.preventDefault()}});o=Backbone.View.extend({initialize:function(){return this.model.on("openNewTemplateModal",this.open,this)},events:{"click #create-template-button":"createTemplateButtonClickHandler","keypress input":"inputKeyPressHandler"},inputKeyPressHandler:function(s){if(s.which===13){this.createTemplateButtonClickHandler();return s.preventDefault()}},open:function(s){this.templateGroupModel=s;$("#id2_templategroup").val(s.id);this.removeErrors();this.$el.find("form").each(function(){return this.reset()});$("#id2_template_is_private_0").prop("checked",true);this.$el.modal("show");return $("#id2_template_short_name").focus()},removeErrors:function(){this.$el.find(".alert").remove();return this.$el.find(".error").removeClass("error")},close:function(){return this.$el.modal("hide")},createTemplateButtonClickHandler:function(t){var s;s=this.$el.find("form").serializeObject();s.template_cache_timeout=0;this.temp_model=new p(s);this.temp_model.save({},{success:d(function(v,u){v.templateGroupModel(this.templateGroupModel);this.collection.add(v);return this.close()},this),error:d(function(w,u){var v,x;this.removeErrors();if(u.status===400){x=$.parseJSON(u.responseText);v="";return _.each(x.errors,function(z,y){_.each(z,function(B,A){return v+=_.template("<li><%= error %></li>",{error:B})});$("#id2_"+y).before(_.template($("#form-error-template").text(),{errors:v}));return $("#id2_"+y).parent().addClass("error")})}},this)});if(t){return t.preventDefault()}}});f=Backbone.View.extend({initialize:function(){return this.model.on("openNewTemplateGroupModal",this.open,this)},events:{"click #create-templategroup-button":"createTemplateGroupButtonClickHandler","keypress input":"inputKeyPressHandler"},inputKeyPressHandler:function(s){if(s.which===13){this.createTemplateGroupButtonClickHandler();return s.preventDefault()}},open:function(){this.removeErrors();this.$el.find("form").each(function(){return this.reset()});this.$el.modal("show");return $("#id_templategroup_short_name").focus()},removeErrors:function(){this.$el.find(".alert").remove();return this.$el.find(".error").removeClass("error")},close:function(){return this.$el.modal("hide")},createTemplateGroupButtonClickHandler:function(t){var s;s=this.$el.find("form").serializeObject();$.post(templateGroupRoot,JSON.stringify(s),d(function(x,y,w){var u,v;if(w.status===200){v=new n(x.templategroup);u=new p(x.template);u.templateGroupModel(v);v.indexTemplateModel(u);this.options.templateGroupCollection.add(v);this.options.templateCollection.add(u);this.model.selectedTemplate(u);return this.close()}},this),"json").error(d(function(v){var u,w;this.removeErrors();if(v.status===400){w=$.parseJSON(v.responseText);u="";return _.each(w.errors,function(y,x){_.each(y,function(A,z){return u+=_.template("<li><%= error %></li>",{error:A})});$("#id_"+x).before(_.template($("#form-error-template").text(),{errors:u}));return $("#id_"+x).parent().addClass("error")})}},this));if(t){return t.preventDefault()}}});j=Backbone.View.extend({initialize:function(){return this.model.on("openEditTemplateGroupModal",this.open,this)},events:{"click #save-templategroup-button":"saveTemplateGroupButtonClickHandler","click #delete-templategroup-button":"deleteTemplateGroupButtonClickHandler","keypress input":"inputKeyPressHandler"},inputKeyPressHandler:function(s){if(s.which===13){this.saveTemplateGroupButtonClickHandler();return s.preventDefault()}},open:function(s){this.templateGroupModel=s;this.removeErrors();this.$el.find("form").each(function(){return this.reset()});this.$el.modal("show");return $("#id2_templategroup_short_name").val(this.templateGroupModel.get("templategroup_short_name")).focus()},removeErrors:function(){this.$el.find(".alert").remove();return this.$el.find(".error").removeClass("error")},close:function(){return this.$el.modal("hide")},saveTemplateGroupButtonClickHandler:function(t){var s;s=this.$el.find("form").serializeObject();if(s.templategroup_short_name===this.templateGroupModel.get("templategroup_short_name")){this.close();return}this.templateGroupModel.save(s,{wait:true,success:d(function(){return this.close()},this),error:d(function(w,u){var v,x;this.removeErrors();if(u.status===400){x=$.parseJSON(u.responseText);v="";return _.each(x.errors,function(z,y){_.each(z,function(B,A){return v+=_.template("<li><%= error %></li>",{error:B})});$("#id2_"+y).before(_.template($("#form-error-template").text(),{errors:v}));return $("#id2_"+y).parent().addClass("error")})}},this)});if(t){return t.preventDefault()}},deleteTemplateGroupButtonClickHandler:function(s){this.close();this.model.openConfirmDeleteTemplateGroupModal(this.templateGroupModel);return s.preventDefault()}});k=Backbone.View.extend({initialize:function(){return this.model.on("openConfirmDeleteTemplateGroupModal",this.open,this)},events:{"click #confirm-delete-templategroup-button":"confirmDeleteHandler"},open:function(s){this.templateGroupModel=s;return this.$el.modal("show")},close:function(){return this.$el.modal("hide")},confirmDeleteHandler:function(s){this.templateGroupModel.destroy();this.close();this.model.selectedTemplate(this.model.rootTemplateGroup().indexTemplateModel());return s.preventDefault()}});$(function(){var t,x,y,u,A,C,w,z,D,B,v,s;window.appModel=new i();B=new c();s=new g();t=new e({el:$(".action-bar"),model:window.appModel});D=new r({el:$("#template-browser"),model:window.appModel,templateCollection:B,templateGroupCollection:s});v=new b({el:$("#editor-pane"),model:window.appModel});z=new q({el:$("#settings-pane"),model:window.appModel});w=new o({el:$("#create-template-modal"),model:window.appModel,collection:B});y=new h({el:$("#delete-template-modal"),model:window.appModel});A=new l({el:$("#media_chooser_modal"),model:window.appModel});C=new f({el:$("#create-templategroup-modal"),model:window.appModel,templateGroupCollection:s,templateCollection:B});u=new j({el:$("#edit-templategroup-modal"),model:window.appModel});x=new k({el:$("#delete-templategroup-modal"),model:window.appModel});$("#tabs a").click(function(E){$(this).tab("show");return E.preventDefault()});return $("#tabs a:first").tab("show")})}).call(this);